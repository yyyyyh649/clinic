# 登录方式更新指南

## 更新说明

本次更新将小程序的登录注册方式从「手机号+短信验证码」改为「微信绑定+手机号（无需验证）」的方式。

## 主要变更

### 1. 客户端登录流程

#### 旧流程
1. 用户输入手机号
2. 点击"获取验证码"按钮
3. 输入收到的短信验证码
4. 点击"登录"按钮

#### 新流程
- **首次使用用户**：
  1. 点击"微信授权登录"按钮
  2. 授权后，系统提示输入手机号
  3. 输入手机号，点击"完成注册"
  4. 注册成功，自动登录

- **已注册用户**：
  1. 点击"微信授权登录"按钮
  2. 自动识别并登录（无需输入任何信息）

### 2. 店员端登录流程

#### 登录方式
店员端现在支持两种登录方式：

1. **微信快捷登录**（推荐）
   - 点击"微信快捷登录"按钮
   - 自动识别已绑定的店员账号并登录

2. **手机号+密码登录**（传统方式）
   - 输入手机号和密码
   - 点击"登录"按钮

#### 注册流程
1. 输入姓名、手机号、密码、确认密码、员工编号
2. 点击"微信授权绑定"按钮（可选，但建议绑定以启用快捷登录）
3. 点击"提交注册"
4. 等待管理员审核

## 技术实现

### 客户端变更

#### miniprogram/pages/login/login.js
- 移除了 `code` 和 `countdown` 数据字段
- 移除了 `sendCode` 函数（发送验证码）
- 移除了 `handleLogin` 函数（手机号登录）
- 移除了 `onCodeInput` 函数
- 新增 `showPhoneInput` 和 `pendingUserInfo` 数据字段
- 新增 `submitPhone` 函数（提交手机号完成注册）
- 更新 `onGetUserInfo` 函数以处理新用户注册流程

#### miniprogram/pages/login/login.wxml
- 移除了验证码输入框
- 移除了"获取验证码"按钮
- 移除了分割线
- 将微信登录按钮移至主要位置
- 新增条件显示的手机号输入区域（仅新用户显示）

#### miniprogram/pages/staff/login/login.js
- 新增 `wechatBound` 和 `wechatUserInfo` 数据字段
- 新增 `onWechatLogin` 函数（微信登录）
- 新增 `onWechatBind` 函数（注册时绑定微信）
- 更新 `handleRegister` 函数以支持微信绑定

#### miniprogram/pages/staff/login/login.wxml
- 在登录表单顶部新增"微信快捷登录"按钮
- 在注册表单中新增"微信授权绑定"区域

### 云函数变更

#### cloud/functions/login/index.js
- 移除了 `phoneLogin` action
- 新增 `bindPhone` action（绑定手机号）
- 更新 `wechatLogin` 函数：
  - 如果用户已存在，直接登录
  - 如果用户不存在，返回 `needPhone: true` 标志
- 新增 `bindPhone` 函数：
  - 创建新用户账号
  - 绑定微信 openid 和手机号
  - 处理手机号已被使用的情况

#### cloud/functions/staff/index.js
- 新增 `wechatLogin` action
- 更新 `register` 函数以接受可选的 `userInfo` 参数
- 新增 `wechatLogin` 函数：
  - 通过 openid 查找店员账号
  - 验证账号审核状态
  - 更新微信用户信息

## 数据库变更

### users 集合
无需变更，现有字段已足够：
- `openid`: 微信 openid（必填）
- `phone`: 手机号（可能为空，仅首次微信登录后需要）
- 其他字段保持不变

### staff 集合
建议新增字段（可选，用于更好的用户体验）：
- `nickName`: 微信昵称
- `avatarUrl`: 微信头像

## 部署步骤

### 1. 备份数据
```bash
# 在云开发控制台导出以下集合的数据
- users
- staff
```

### 2. 上传云函数
在微信开发者工具中：
1. 右键点击 `cloud/functions/login`
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
4. 重复以上步骤部署 `cloud/functions/staff`

### 3. 发布小程序
1. 在开发者工具中点击"上传"
2. 填写版本号和更新说明
3. 登录微信公众平台
4. 提交审核
5. 审核通过后发布

### 4. 测试验证
部署后请测试以下场景：

#### 客户端测试
- [ ] 新用户微信授权注册（需输入手机号）
- [ ] 已注册用户微信授权登录
- [ ] 手机号已存在但未绑定微信的用户登录
- [ ] 手机号已被其他微信账号绑定的错误提示

#### 店员端测试
- [ ] 新店员注册（含微信绑定）
- [ ] 新店员注册（不绑定微信）
- [ ] 已注册店员微信快捷登录
- [ ] 已注册店员手机号密码登录
- [ ] 未审核店员登录拦截

## 优势

### 1. 成本节约
- 无需对接短信服务商
- 无需支付短信费用（约0.05元/条）
- 减少短信轰炸和恶意验证的风险

### 2. 用户体验提升
- **老用户**：一键微信授权即可登录，无需输入任何信息
- **新用户**：只需授权微信 + 输入手机号，省去等待验证码的时间
- **店员**：可选择微信快捷登录，提高工作效率

### 3. 安全性
- 依托微信平台的身份验证
- openid 作为唯一标识，防止账号冒用
- 保留手机号信息便于后续客户管理

### 4. 维护便利
- 减少短信服务商对接和维护成本
- 简化验证码逻辑，降低系统复杂度
- 利用微信生态，提高用户留存

## 注意事项

### 1. 数据迁移
对于现有用户：
- 已有 `openid` 的用户：无需任何操作，可直接使用微信登录
- 只有 `phone` 没有 `openid` 的用户：首次使用微信登录时会自动绑定

### 2. 兼容性处理
云函数已处理以下情况：
- 手机号已被其他微信账号绑定
- 用户有手机号但未绑定微信
- 用户有微信但未填写手机号

### 3. 隐私合规
根据《个人信息保护法》和微信小程序规范：
- 获取手机号仅用于用户识别和后续服务
- 应在用户协议中明确说明数据使用目的
- 不得将用户手机号用于营销推广（除非用户明确同意）

## 常见问题

### Q1: 老用户如何迁移到新登录方式？
**A:** 老用户首次使用时，点击"微信授权登录"即可。如果手机号已存在，系统会自动关联微信账号。

### Q2: 如果用户更换微信号怎么办？
**A:** 用户需要联系管理员，在数据库中更新 `openid` 字段。后续可考虑添加"账号申诉"功能。

### Q3: 店员可以不绑定微信吗？
**A:** 可以。店员仍然可以使用手机号+密码登录。微信绑定是可选的，但建议绑定以便使用快捷登录。

### Q4: 如何处理手机号已被绑定的情况？
**A:** 系统会提示"该手机号已被其他微信账号绑定"。这种情况下，用户可能需要：
1. 使用其他手机号注册
2. 联系管理员处理账号问题

### Q5: 短信验证相关的代码是否完全删除？
**A:** 是的。所有短信验证相关的代码（包括前端输入框、倒计时、云函数验证逻辑）都已移除。

## 回滚方案

如果需要回滚到旧版本：

1. 在 Git 中回滚到更新前的 commit
2. 重新部署云函数
3. 重新上传小程序代码
4. 提交审核并发布

注意：回滚后，使用新方式注册的用户可能需要重新注册。

## 联系支持

如有问题，请：
1. 查看本文档的常见问题部分
2. 在项目 Issues 中提问
3. 联系开发团队

---

**更新日期**: 2025-12-28
**版本**: 2.0.0
